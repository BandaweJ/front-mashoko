<mat-toolbar color="primary" class="finance-dashboard-toolbar">
  <div class="toolbar-left-content">
    <span class="toolbar-title" *ngIf="!isSearchBarVisible">Finance Dashboard</span>
    <div class="toolbar-search-container" [class.visible]="isSearchBarVisible">
      <app-search-finance-entity *ngIf="isSearchBarVisible"
        (entitySelected)="onFinancialEntitySelectedFromSearch($event)"
        class="toolbar-search-component"></app-search-finance-entity>
    </div>
  </div>

  <div class="toolbar-icons">
    <button mat-icon-button (click)="toggleSearchBar()" aria-label="Toggle search">
      <mat-icon>{{ isSearchBarVisible ? 'close' : 'search' }}</mat-icon>
    </button>
    <button mat-icon-button (click)="onFilter()" aria-label="Filter financial data">
      <mat-icon>filter_list</mat-icon>
    </button>
    <button mat-icon-button [matMenuTriggerFor]="sortMenu" aria-label="Sort financial data">
      <mat-icon>sort</mat-icon>
    </button>
    <mat-menu #sortMenu="matMenu">
      <button mat-menu-item *ngFor="let option of sortOptions" (click)="onSortChange(option.value)">
        {{ option.label }}
        <mat-icon *ngIf="(currentSort$ | async) === option.value">done</mat-icon>
      </button>
    </mat-menu>
    <button mat-icon-button (click)="onClearFilters()" aria-label="Clear all filters">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>
</mat-toolbar>

<div class="finance-dashboard-container">
  <div class="summary-cards">
    <mat-card class="summary-card total-invoices-card">
      <div class="summary-card-content">
        <mat-icon class="card-icon">receipt_long</mat-icon>
        <div class="summary-text">
          <div class="card-label">Total Invoices</div>
          <div class="card-value">{{ totalInvoices$ | async | currency:'USD' }}</div>
        </div>
      </div>
    </mat-card>

    <mat-card class="summary-card total-payments-card">
      <div class="summary-card-content">
        <mat-icon class="card-icon">payments</mat-icon>
        <div class="summary-text">
          <div class="card-label">Total Payments</div>
          <div class="card-value">{{ totalPayments$ | async | currency:'USD' }}</div>
        </div>
      </div>
    </mat-card>

    <mat-card class="summary-card total-balance-card">
      <div class="summary-card-content">
        <mat-icon class="card-icon">account_balance_wallet</mat-icon>
        <div class="summary-text">
          <div class="card-label">Outstanding Balance</div>
          <div class="card-value">{{ totalBalance$ | async | currency:'USD' }}</div>
        </div>
      </div>
    </mat-card>
  </div>

  <mat-card class="chart-card">
    <mat-card-header>
      <mat-card-title>Monthly Revenue vs Payments</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="chart-container">
        <canvas #chart baseChart [options]="barChartOptions" [data]="barChartData" [type]="barChartType">
        </canvas>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="tables-container">
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Recent Invoices</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="invoicesDataSource.data.length > 0; else noDataFound">
          <table mat-table [dataSource]="invoicesDataSource" class="finance-data-table" matSort #sort1="matSort">
            <ng-container matColumnDef="transactionIcon">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element" class="icon-cell">
                <mat-icon class="icon-invoice">description</mat-icon>
              </td>
            </ng-container>
            <ng-container matColumnDef="transactionDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
              <td mat-cell *matCellDef="let element">{{ element.transactionDate | date }}</td>
            </ng-container>
            <ng-container matColumnDef="studentName">
              <th mat-header-cell *matHeaderCellDef>Student</th>
              <td mat-cell *matCellDef="let element">{{ element.studentName }}</td>
            </ng-container>
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
              <td mat-cell *matCellDef="let element" class="amount-cell amount-invoice">
                {{ element.amount | currency:'USD' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let element"
                [ngClass]="{'status-paid': element.status === 'Paid', 'status-overdue': element.status === 'Overdue'}">
                {{ element.status }}
              </td>
            </ng-container>
            <tr mat-header-row
              *matHeaderRowDef="['transactionIcon', 'transactionDate', 'studentName', 'amount', 'status']"></tr>
            <tr mat-row
              *matRowDef="let row; columns: ['transactionIcon', 'transactionDate', 'studentName', 'amount', 'status']">
            </tr>
          </table>
          <mat-paginator #invoicesPaginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Recent Payments</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="paymentsDataSource.data.length > 0; else noDataFound">
          <table mat-table [dataSource]="paymentsDataSource" class="finance-data-table" matSort #sort2="matSort">
            <ng-container matColumnDef="transactionIcon">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element" class="icon-cell">
                <mat-icon class="icon-payment">receipt</mat-icon>
              </td>
            </ng-container>
            <ng-container matColumnDef="transactionDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
              <td mat-cell *matCellDef="let element">{{ element.transactionDate | date }}</td>
            </ng-container>
            <ng-container matColumnDef="studentName">
              <th mat-header-cell *matHeaderCellDef>Student</th>
              <td mat-cell *matCellDef="let element">{{ element.studentName }}</td>
            </ng-container>
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
              <td mat-cell *matCellDef="let element" class="amount-cell amount-payment">
                {{ element.amount | currency:'USD' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Description</th>
              <td mat-cell *matCellDef="let element">{{ element.description }}</td>
            </ng-container>
            <tr mat-header-row
              *matHeaderRowDef="['transactionIcon', 'transactionDate', 'studentName', 'amount', 'description']"></tr>
            <tr mat-row
              *matRowDef="let row; columns: ['transactionIcon', 'transactionDate', 'studentName', 'amount', 'description']">
            </tr>
          </table>
          <mat-paginator #paymentsPaginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<ng-template #noDataFound>
  <div class="no-data-found">
    <mat-icon>info</mat-icon>
    <p>No financial records found matching your criteria.</p>
    <button mat-flat-button color="accent" (click)="onClearFilters()">Clear Filters</button>
  </div>
</ng-template>